import {compose, lifecycle} from 'recompose';
import {connect} from 'react-redux';
import {bindActionCreators} from 'redux';

import {fetchAvatarsForUsers} from '@ciscospark/redux-module-avatar';


export default compose(
  null,
  connect(
    (dispatch) => bindActionCreators({
      fetchAvatarsForUsers
    }, dispatch)
  ),
  lifecycle({
    componentDidMount() {
      const {props} = this;
      const {
        sparkInstance,
        activityCount,
        participants
      } = props;
      if (activityCount) {
        const userIds = participants.map((p) => p.id);
        props.fetchAvatarsForUsers(userIds, sparkInstance);
      }
    },
    componentWillReceiveProps(nextProps) {
      const {props} = this;
      const {
        sparkInstance,
        activityCount,
        participants
      } = nextProps;
      const prevActivitiesCount = props.activityCount;
      if (activityCount && activityCount !== prevActivitiesCount) {
        const userIds = participants.map((p) => p.id);
        props.fetchAvatarsForUsers(userIds, sparkInstance);
      }
    }
  })
);
